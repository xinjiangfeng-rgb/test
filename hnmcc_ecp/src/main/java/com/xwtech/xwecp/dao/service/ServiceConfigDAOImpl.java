package com.xwtech.xwecp.dao.service;

import com.alibaba.fastjson.JSON;
import com.xwtech.xwecp.dao.BaseDAO;
import com.xwtech.xwecp.service.config.InvalidConfigException;
import com.xwtech.xwecp.service.config.ServiceConfig;
import com.xwtech.xwecp.service.config.ServiceConfigAnalyzer;
import com.xwtech.xwecp.service.config.ServiceInputParameter;
import org.slf4j.Logger;import org.slf4j.LoggerFactory;
import org.springframework.jdbc.core.PreparedStatementSetter;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.jdbc.core.support.SqlLobValue;
import org.springframework.stereotype.Repository;

import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;


@Repository("serviceConfigDAO")
public class ServiceConfigDAOImpl extends BaseDAO implements IServiceConfigDAO
{
    private static final Logger logger = LoggerFactory.getLogger(ServiceConfigDAOImpl.class);





    public ServiceConfig getServiceConfig(String cmd)
    {
        String configTmp = "";
        ServiceConfig config = null;
        Map mapResult = null;
//        configTmp = (String)getCache().get("F_LI_ALL_TMP_KEY_" + cmd);
        if(null != getCache().get("F_LI_ALL_TMP_KEY_TEST_" + cmd)){
        	configTmp = JSON.parse(getCache().get("F_LI_ALL_TMP_KEY_TEST_" + cmd)).toString();
        }
        if (configTmp == null || ("").equals(configTmp))
        {
            String sql = "select  tlf.F_LI_ALL_TMP  from T_LINTERFACE_DA_TEST tlf where tlf.F_LI_NUMBER='" + cmd
                + "' and tlf.F_LI_STATE = 1"; // 如果被禁用会导致查询不到.
            try
            {
                mapResult = (Map)this.getJdbcTemplate().queryForObject(sql, new RowMapper()
                {
                    public Object mapRow(ResultSet rs, int rowNum)
                        throws SQLException
                    {
                        Map<String, String> mapRs = new HashMap<String, String>();                        
                        ResultSetMetaData metaData = rs.getMetaData();
                        
                        for (int num = 1; num <= metaData.getColumnCount(); num++)
                        {
                        	
//                            if (metaData.getColumnType(num) == Types.CLOB)
//                            {
                                
                                mapRs.put(metaData.getColumnName(num).toLowerCase(),rs.getString(num));
//                                    lobHandler.getClobAsString(rs, num));
//                            }
                        }
                        return mapRs;
                    }
                });
            }
            catch (Exception e)
            {
                logger.error(e.getMessage(), e);
                logger.error("操作数据库出现错误！！！");
                return null;
            }
            configTmp = (String)mapResult.get("f_li_all_tmp");
//            getCache().add("F_LI_ALL_TMP_KEY_" + cmd, configTmp);
            getCache().add("F_LI_ALL_TMP_KEY_TEST_" + cmd, JSON.toJSONString(configTmp));
        }
        
        if (!"".equals(configTmp) && configTmp != null)
        {
            
            try
            {
                config = new ServiceConfigAnalyzer().read(configTmp);
                
            }
            catch (InvalidConfigException e)
            {
                logger.error(e.getMessage(), e);
                logger.error("解析模板配置出现错误");
            }
            
        }
        
        return config;
    }
    
//    protected ServiceConfig getSimulatedService_DirectiveImplementation(String cmd)
//    {
//        ServiceConfig config = new ServiceConfig();
//        ServiceInput input = new ServiceInput();
//        ServiceOutput output = new ServiceOutput();
//        ServiceImplementation impl = new ServiceImplementation();
//        ServiceExtension ext = new ServiceExtension();
//
//        config.setCmd(cmd);
//        config.setName("login");
//        config.setNamespace("com.xwtech.xwecp.service.logic");
//        config.setChineseName("用户登陆");
//        config.setDescription("用户登陆 - 测试配置");
//        config.setInput(input);
//        config.setOutput(output);
//        config.setImpl(impl);
//        config.setExtension(ext);
//
//        ServiceInputParameter mobile = new ServiceInputParameter();
//        mobile.setName("mobile");
//        mobile.setDataType(DataTypeConstants.STRING);
//        mobile.setRegular("");
//        ServiceInputParameter pwd = new ServiceInputParameter();
//        pwd.setName("password");
//        pwd.setDataType(DataTypeConstants.STRING);
//        pwd.setRegular("");
//        input.getParams().add(mobile);
//        input.getParams().add(pwd);
//
//        ServiceOutputField balance = new ServiceOutputField();
//        balance.setDataType(DataTypeConstants.INT);
//        balance.setName("balance");
//
//        ServiceOutputField custName = new ServiceOutputField();
//        custName.setDataType(DataTypeConstants.STRING);
//        custName.setName("custName");
//
//        output.getOutputFields().add(balance);
//        output.getOutputFields().add(custName);
//
//        impl.setDirectImpl(true);
//        impl.setImplClass("com.xwtech.xwecp.test.ServiceImplTest");
//
//        ServiceResultMapping balanceMapping = new ServiceResultMapping();
//        balanceMapping.setName("balance");
//        balanceMapping.setExpression("xpath(/test/balance/text())");
//
//        ServiceResultMapping custNameMapping = new ServiceResultMapping();
//        custNameMapping.setName("custName");
//        custNameMapping.setExpression("xpath(/test/custName/text())");
//
//        // impl.getResultMapping().add(balanceMapping);
//        // impl.getResultMapping().add(custNameMapping);
//
//        return config;
//    }
//
//    protected ServiceConfig getSimulatedService_Adapting(String cmd)
//    {
//        ServiceConfig config = new ServiceConfig();
//        ServiceInput input = new ServiceInput();
//        ServiceOutput output = new ServiceOutput();
//        ServiceImplementation impl = new ServiceImplementation();
//        ServiceExtension ext = new ServiceExtension();
//
//        config.setCmd(cmd);
//        config.setName("login");
//        config.setNamespace("com.xwtech.xwecp.service.logic");
//        config.setChineseName("用户登陆");
//        config.setDescription("用户登陆 - 测试配置");
//        config.setInput(input);
//        config.setOutput(output);
//        config.setImpl(impl);
//        config.setExtension(ext);
//
//        ServiceInputParameter mobile = new ServiceInputParameter();
//        mobile.setName("mobile");
//        mobile.setDataType(DataTypeConstants.STRING);
//        mobile.setRegular("");
//        ServiceInputParameter pwd = new ServiceInputParameter();
//        pwd.setName("password");
//        pwd.setDataType(DataTypeConstants.STRING);
//        pwd.setRegular("");
//        input.getParams().add(mobile);
//        input.getParams().add(pwd);
//
//        ServiceOutputField balance = new ServiceOutputField();
//        balance.setDataType(DataTypeConstants.INT);
//        balance.setName("balance");
//
//        ServiceOutputField custName = new ServiceOutputField();
//        custName.setDataType(DataTypeConstants.STRING);
//        custName.setName("custName");
//
//        output.getOutputFields().add(balance);
//        output.getOutputFields().add(custName);
//
//        impl.setDirectImpl(false);
//        TeletextMapping teletextMapping = new TeletextMapping();
//        teletextMapping.setParamName("mobile");
//        teletextMapping.setMatch("*");
//        teletextMapping.setTeletextTemplate("10110");
//        teletextMapping.setResolverClass("com.xwtech.xwecp.test.TeletextResolverTest");
//
//        ServiceResultMapping balanceMapping = new ServiceResultMapping();
//        balanceMapping.setName("balance");
//        balanceMapping.setExpression("xpath(/test/balance/text())");
//
//        ServiceResultMapping custNameMapping = new ServiceResultMapping();
//        custNameMapping.setName("custName");
//        custNameMapping.setExpression("xpath(/test/custName/text())");
//
//        // impl.getResultMapping().add(balanceMapping);
//        // impl.getResultMapping().add(custNameMapping);
//
//        return config;
//    }
    
    public void addServiceConfig(String xml, ServiceConfig config)
    {
        String impClass = "";
        int numWay = 0;
        final ServiceConfig serviceConfig = config;
        final String tmpXml = xml;
        try
        {
            
            boolean direct = serviceConfig.getImpl().isDirectImpl();
            if (direct)
            {
                impClass = serviceConfig.getImpl().getImplClass();
                numWay = 1;
            }
            else
            {
                numWay = 0;
            }
            final int numImplWay = numWay;
            if (serviceConfig != null)
            {
                final String fimpClass = impClass;
                String delWhere = " where F_LI_NUMBER=?";
                
                String delSql = "delete from T_LINTERFACE_DA_TEST ";
                String delMxSql = "delete from T_LINTERFACE_IN_MX ";
                // 先删除数据库中cmd中相同的记录
                this.getJdbcTemplate().update(delMxSql + delWhere, new PreparedStatementSetter()
                {
                    public void setValues(PreparedStatement ps)
                        throws SQLException
                    {
                        ps.setString(1, serviceConfig.getCmd());
                        
                    }
                });
                this.getJdbcTemplate().update(delSql + delWhere, new PreparedStatementSetter()
                {
                    public void setValues(PreparedStatement ps)
                        throws SQLException
                    {
                        ps.setString(1, serviceConfig.getCmd());
                        
                    }
                });
                
                this.getJdbcTemplate()
                    .update("insert into T_LINTERFACE_DA_TEST values(?,?,?,?,?,'','',?,'',?,EMPTY_CLOB(),1,'')",
                        new PreparedStatementSetter()
                        {
                            public void setValues(PreparedStatement ps)
                                throws SQLException
                            {
                                ps.setString(1, serviceConfig.getCmd());
                                ps.setString(2, serviceConfig.getChineseName());
                                ps.setString(3, serviceConfig.getDescription());
                                ps.setString(4, serviceConfig.getName());
                                ps.setString(5, serviceConfig.getNamespace());
                                ps.setInt(6, numImplWay);
                                ps.setString(7, fimpClass);
                                
                            }
                        });
                
                String sql = "update T_LINTERFACE_DA_TEST set F_LI_ALL_TMP=? where F_LI_NUMBER='" + serviceConfig.getCmd()
                    + "'";
                SqlLobValue[] values = new SqlLobValue[1];
                values[0] = new SqlLobValue(tmpXml);
                updateForClob(sql, values);
                
                // //////////////////////////////
                List list = serviceConfig.getInput().getParams();
                for (int i = 0; i < list.size(); i++)
                {
                    final ServiceInputParameter inParameter = (ServiceInputParameter)list.get(i);
                    this.getJdbcTemplate().update("insert into T_LINTERFACE_IN_MX values(?,?,?,?,?,?,?)",
                        new PreparedStatementSetter()
                        {
                            public void setValues(PreparedStatement ps)
                                throws SQLException
                            {
                                ps.setString(1, serviceConfig.getCmd());
                                ps.setString(2, inParameter.getName());
                                ps.setString(3, inParameter.getDataType());
                                ps.setString(4, inParameter.getClassName());
                                ps.setString(5, inParameter.getDefaultValue());
                                ps.setInt(6, inParameter.getIndex());
                                
                                ps.setString(7, inParameter.getRegular());
                                
                            }
                        });
                }
                
            }
        }
        catch (Exception e)
        {
            logger.error(e.getMessage(), e);
            logger.error("操作数据库失败！！！");
            return;
        }
        
    }
}
